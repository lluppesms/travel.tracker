@page "/map"
@using TravelTracker.Data.Models
@using TravelTracker.Services.Interfaces
@implements IAsyncDisposable
@inject ILocationService LocationService
@inject IAuthenticationService AuthenticationService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@inject ILogger<MapView> Logger

<PageTitle>Map - Travel Tracker</PageTitle>

<div class="map-container">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    <div class="map-layout">
        <!-- Left Sidebar with Filters -->
        <div class="map-sidebar">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Location Type Filters -->
                    <div class="filter-section">
                        <h6 class="filter-title">Location Types</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterNationalParks" 
                                   @bind="filterNationalParks" @bind:event="oninput">
                            <label class="form-check-label" for="filterNationalParks">
                                Natl Parks/Monuments
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterHarvestHosts" 
                                   @bind="filterHarvestHosts" @bind:event="oninput">
                            <label class="form-check-label" for="filterHarvestHosts">
                                Harvest Hosts
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterPresidentialLibraries" 
                                   @bind="filterPresidentialLibraries" @bind:event="oninput">
                            <label class="form-check-label" for="filterPresidentialLibraries">
                                Presidential Libraries
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterRVParks" 
                                   @bind="filterRVParks" @bind:event="oninput">
                            <label class="form-check-label" for="filterRVParks">
                                RV Parks
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterFamily" 
                                   @bind="filterFamily" @bind:event="oninput">
                            <label class="form-check-label" for="filterFamily">
                                Family
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filterBoondocking" 
                                   @bind="filterBoondocking" @bind:event="oninput">
                            <label class="form-check-label" for="filterBoondocking">
                                Boondocking
                            </label>
                        </div>
                    </div>

                    <hr />

                    <!-- Date Range Filter -->
                    <div class="filter-section">
                        <h6 class="filter-title">Dates</h6>
                        <div class="mb-3">
                            <label class="form-label">Start</label>
                            <input type="date" class="form-control" @bind="filterStartDate" @bind:event="oninput" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End</label>
                            <input type="date" class="form-control" @bind="filterEndDate" @bind:event="oninput" />
                        </div>
                    </div>

                    <button class="btn btn-outline-secondary w-100 mb-2" @onclick="ClearFilters">
                        Clear Filter
                    </button>

                    <hr />

                    <!-- Statistics -->
                    <div class="filter-section">
                        <h6 class="filter-title">Statistics</h6>
                        <p class="stat-text">Locations: @filteredLocations.Count</p>
                        <p class="stat-text">States: @visitedStates.Count / 50</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Area -->
        <div class="map-area">
            <div class="card h-100">
                <div class="card-body p-0" style="position: relative;">
                    @if (isLoading)
                    {
                        <div class="d-flex align-items-center justify-content-center h-100" style="min-height: 600px;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Loading map data...</p>
                            </div>
                        </div>
                    }
                    else if (string.IsNullOrEmpty(azureMapsKey))
                    {
                        <div class="d-flex align-items-center justify-content-center h-100" style="min-height: 600px;">
                            <div class="text-center p-4">
                                <h3 class="text-muted mb-3">üó∫Ô∏è</h3>
                                <h5 class="mb-3">Azure Maps Not Configured</h5>
                                <p class="text-muted">Configure Azure Maps in appsettings.json to enable map visualization.</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div id="azureMap" style="height: 100%; width: 100%; min-height: 600px;"></div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .map-container {
        padding: 0;
        margin: 0;
    }

    .map-layout {
        display: flex;
        gap: 1.5rem;
        height: calc(100vh - 120px);
        min-height: 600px;
    }

    .map-sidebar {
        flex: 0 0 320px;
        max-width: 320px;
        overflow-y: auto;
    }

    .map-area {
        flex: 1;
        min-width: 0;
    }

    .filter-section {
        margin-bottom: 1rem;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .form-check {
        margin-bottom: 0.5rem;
    }

    .form-check-label {
        font-size: 0.9rem;
    }

    .stat-text {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    @@media (max-width: 991px) {
        .map-layout {
            flex-direction: column;
            height: auto;
        }

        .map-sidebar {
            flex: 0 0 auto;
            max-width: 100%;
        }

        .map-area {
            min-height: 500px;
        }
    }
</style>

@code {
    private List<Location> allLocations = new();
    private List<Location> filteredLocations = new();
    private HashSet<string> visitedStates = new();
    private HashSet<string> tripNames = new();
    private bool isLoading = false;
    private bool isMapInitialized = false;
    private bool afterRenderCalled = false;
    private string errorMessage = string.Empty;
    private int currentUserId;
    private string? azureMapsKey;

    // New checkbox filters
    private bool filterNationalParks = false;
    private bool filterHarvestHosts = false;
    private bool filterPresidentialLibraries = false;
    private bool filterRVParks = false;
    private bool filterFamily = false;
    private bool filterBoondocking = false;

    // Date filters
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("MapView.OnInitializedAsync starting");
            currentUserId = AuthenticationService.GetCurrentUserInternalId();
            azureMapsKey = Configuration["AzureMaps:SubscriptionKey"];
            Logger.LogInformation("AzureMaps key present: {HasKey}", !string.IsNullOrEmpty(azureMapsKey));
            await LoadLocations();
            Logger.LogInformation("MapView.OnInitializedAsync completed");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unhandled exception in OnInitializedAsync");
            errorMessage = $"Initialization failed: {ex.Message}";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!afterRenderCalled)
        {
            afterRenderCalled = true;
            Logger.LogInformation("OnAfterRenderAsync invoked. firstRender={FirstRender}", firstRender);
        }

        if (firstRender)
        {
            if (string.IsNullOrEmpty(azureMapsKey))
            {
                Logger.LogWarning("OnAfterRenderAsync first render: Azure Maps key missing. Map will not initialize.");
                return;
            }

            await InitializeMap();
        }
    }

    private async Task InitializeMap()
    {
        try
        {
            Logger.LogInformation("Initializing Azure Map...");
            var result = await JSRuntime.InvokeAsync<bool>("initializeAzureMap", azureMapsKey, 39.8283, -98.5795, 4);
            if (result)
            {
                isMapInitialized = true;
                Logger.LogInformation("Azure Map initialized successfully");
                await UpdateMapMarkers();
            }
            else
            {
                Logger.LogWarning("initializeAzureMap returned false");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to initialize map: {ex.Message}";
            Logger.LogError(ex, "Map initialization error");
        }
    }

    private async Task UpdateMapMarkers()
    {
        if (!isMapInitialized || string.IsNullOrEmpty(azureMapsKey))
        {
            Logger.LogDebug("Skipping UpdateMapMarkers. Initialized={Initialized} HasKey={HasKey}", isMapInitialized, !string.IsNullOrEmpty(azureMapsKey));
            return;
        }

        try
        {
            var markers = filteredLocations
                .Where(l => l.Latitude != 0 && l.Longitude != 0)
                .Select(l => new
                {
                    lat = l.Latitude,
                    lon = l.Longitude,
                    name = l.Name,
                    tripName = l.TripName ?? string.Empty,
                    city = l.City,
                    state = l.State,
                    date = l.StartDate.ToString("yyyy-MM-dd"),
                    locationType = l.LocationType,
                    rating = l.Rating
                })
                .ToArray();

            Logger.LogInformation("Updating map markers. Count={Count}", markers.Length);
            await JSRuntime.InvokeVoidAsync("updateAzureMapMarkers", (object)markers);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to update map markers: {ex.Message}";
            Logger.LogError(ex, "Map marker update error");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isMapInitialized)
            {
                Logger.LogInformation("Disposing Azure Map");
                await JSRuntime.InvokeVoidAsync("disposeAzureMap");
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error during map disposal (ignored)");
        }
    }

    private async Task LoadLocations()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            allLocations = (await LocationService.GetAllLocationsAsync(currentUserId)).ToList();
            filteredLocations = allLocations;

            visitedStates = allLocations
                .Where(l => !string.IsNullOrEmpty(l.State))
                .Select(l => l.State)
                .ToHashSet();

            tripNames = allLocations
                .Where(l => !string.IsNullOrEmpty(l.TripName))
                .Select(l => l.TripName!)
                .ToHashSet();

            Logger.LogInformation("Loaded locations. Count={Count}", allLocations.Count);
            await ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load locations");
            errorMessage = $"Failed to load locations: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        filteredLocations = allLocations;

        // Apply location type filters
        if (filterNationalParks || filterHarvestHosts || filterPresidentialLibraries || 
            filterRVParks || filterFamily || filterBoondocking)
        {
            filteredLocations = filteredLocations.Where(l =>
            {
                var locType = l.LocationType?.ToLower() ?? "";
                
                if (filterNationalParks && (locType.Contains("national park") || locType.Contains("national monument")))
                    return true;
                if (filterHarvestHosts && locType.Contains("harvest host"))
                    return true;
                if (filterPresidentialLibraries && locType.Contains("presidential"))
                    return true;
                if (filterRVParks && (locType.Contains("rv park") || locType.Contains("rv resort")))
                    return true;
                if (filterFamily && locType.Contains("family"))
                    return true;
                if (filterBoondocking && locType.Contains("boondocking"))
                    return true;
                    
                return false;
            }).ToList();
        }

        // Apply date filters
        if (filterStartDate.HasValue)
        {
            filteredLocations = filteredLocations
                .Where(l => l.StartDate >= filterStartDate.Value)
                .ToList();
        }
        if (filterEndDate.HasValue)
        {
            filteredLocations = filteredLocations
                .Where(l => l.StartDate <= filterEndDate.Value)
                .ToList();
        }

        Logger.LogDebug("Filters applied. Filtered count={Count}", filteredLocations.Count);

        if (!string.IsNullOrEmpty(azureMapsKey))
        {
            await UpdateMapMarkers();
        }

        StateHasChanged();
    }

    private Task ClearFilters()
    {
        filterNationalParks = false;
        filterHarvestHosts = false;
        filterPresidentialLibraries = false;
        filterRVParks = false;
        filterFamily = false;
        filterBoondocking = false;
        filterStartDate = null;
        filterEndDate = null;
        Logger.LogInformation("Cleared filters");
        return ApplyFilters();
    }
}
