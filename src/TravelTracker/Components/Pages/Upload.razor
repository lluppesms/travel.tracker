@page "/upload"
@attribute [Authorize]
@using System.Text.Json
@using TravelTracker.Data.Models
@using TravelTracker.Services.Interfaces
@inject ILocationService LocationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Upload Data - Travel Tracker</PageTitle>

<h1>Upload Travel Data</h1>

<div class="container mt-4">
    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">Success!</h4>
            <p>@successMessage</p>
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }
    
    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p>@errorMessage</p>
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
    
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">ðŸ“¤ Data Upload</h4>
                <p>Import your travel data in bulk using JSON format.</p>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Upload JSON File</h5>
                </div>
                <div class="card-body">
                    @if (isUploading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <p class="mt-2">Processing your locations...</p>
                            @if (uploadProgress > 0)
                            {
                                <div class="progress mt-3" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: @(uploadProgress)%;" 
                                         aria-valuenow="@uploadProgress" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        @uploadProgress%
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label for="fileUpload" class="form-label">Select JSON file</label>
                            <InputFile OnChange="HandleFileSelected" class="form-control" accept=".json" />
                        </div>
                        
                        @if (validationResults.Any())
                        {
                            <div class="alert alert-warning">
                                <h6>Validation Results:</h6>
                                <ul class="mb-0">
                                    @foreach (var result in validationResults)
                                    {
                                        <li>@result</li>
                                    }
                                </ul>
                            </div>
                        }
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" @onclick="ProcessUpload" disabled="@(selectedFile == null || isUploading)">
                                <span class="bi bi-upload"></span> Upload and Process
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">JSON Format</h5>
                </div>
                <div class="card-body">
                    <p class="small">Your JSON file should follow this format:</p>
                    <pre class="small bg-light p-2" style="font-size: 0.75rem;"><code>{
  "locations": [
    {
      "name": "Yellowstone NP",
      "locationType": "National Park",
      "address": "WY 82190",
      "city": "Yellowstone",
      "state": "WY",
      "latitude": 44.427963,
      "longitude": -110.588455,
      "startDate": "2024-06-15",
      "endDate": "2024-06-18",
      "rating": 5,
      "comments": "Amazing!",
      "tags": ["national-park"]
    }
  ]
}</code></pre>
                    <button class="btn btn-sm btn-outline-primary" @onclick="DownloadSample">
                        <span class="bi bi-download"></span> Download Sample
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string? errorMessage;
    private string? successMessage;
    private List<string> validationResults = new();
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value
                ?? user.FindFirst("oid")?.Value
                ?? user.FindFirst("sub")?.Value;
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        validationResults.Clear();
        errorMessage = null;
        successMessage = null;
    }

    private async Task ProcessUpload()
    {
        if (selectedFile == null || string.IsNullOrEmpty(userId))
        {
            errorMessage = "Please select a file and ensure you are logged in.";
            return;
        }

        try
        {
            isUploading = true;
            uploadProgress = 0;
            errorMessage = null;
            successMessage = null;
            validationResults.Clear();

            // Read file content
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
            using var reader = new StreamReader(stream);
            var jsonContent = await reader.ReadToEndAsync();

            uploadProgress = 25;
            StateHasChanged();

            // Parse JSON
            var options = new JsonSerializerOptions 
            { 
                PropertyNameCaseInsensitive = true 
            };
            var uploadData = JsonSerializer.Deserialize<LocationUploadData>(jsonContent, options);

            if (uploadData?.Locations == null || !uploadData.Locations.Any())
            {
                errorMessage = "No locations found in the JSON file.";
                isUploading = false;
                return;
            }

            uploadProgress = 50;
            StateHasChanged();

            // Process locations
            int successCount = 0;
            int errorCount = 0;
            int totalLocations = uploadData.Locations.Count;

            foreach (var locationData in uploadData.Locations)
            {
                try
                {
                    var location = new Location
                    {
                        UserId = userId,
                        Name = locationData.Name ?? "Unknown",
                        LocationType = locationData.LocationType ?? "Other",
                        Address = locationData.Address ?? string.Empty,
                        City = locationData.City ?? string.Empty,
                        State = locationData.State ?? string.Empty,
                        ZipCode = locationData.ZipCode ?? string.Empty,
                        Latitude = locationData.Latitude,
                        Longitude = locationData.Longitude,
                        StartDate = locationData.StartDate,
                        EndDate = locationData.EndDate,
                        Rating = locationData.Rating,
                        Comments = locationData.Comments ?? string.Empty,
                        Tags = locationData.Tags ?? new List<string>(),
                        CreatedDate = DateTime.UtcNow,
                        ModifiedDate = DateTime.UtcNow
                    };

                    await LocationService.CreateLocationAsync(location);
                    successCount++;
                    
                    // Update progress
                    uploadProgress = 50 + (int)((successCount + errorCount) * 50.0 / totalLocations);
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    errorCount++;
                    validationResults.Add($"Error processing location '{locationData.Name}': {ex.Message}");
                }
            }

            uploadProgress = 100;
            StateHasChanged();

            if (successCount > 0)
            {
                successMessage = $"Successfully uploaded {successCount} location(s). {(errorCount > 0 ? $"{errorCount} location(s) failed." : "")}";
            }
            else
            {
                errorMessage = "Failed to upload any locations. Please check the validation results.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing file: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            selectedFile = null;
        }
    }

    private async Task DownloadSample()
    {
        var sampleData = new LocationUploadData
        {
            Locations = new List<LocationUploadItem>
            {
                new LocationUploadItem
                {
                    Name = "Yellowstone National Park",
                    LocationType = "National Park",
                    Address = "Yellowstone National Park",
                    City = "Yellowstone",
                    State = "WY",
                    ZipCode = "82190",
                    Latitude = 44.427963,
                    Longitude = -110.588455,
                    StartDate = DateTime.Parse("2024-06-15"),
                    EndDate = DateTime.Parse("2024-06-18"),
                    Rating = 5,
                    Comments = "Amazing scenery and wildlife!",
                    Tags = new List<string> { "national-park", "nature" }
                }
            }
        };

        var json = JsonSerializer.Serialize(sampleData, new JsonSerializerOptions 
        { 
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        });
        
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        var dataUrl = $"data:application/json;base64,{base64}";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", "sample-locations.json", dataUrl);
    }

    public class LocationUploadData
    {
        public List<LocationUploadItem> Locations { get; set; } = new();
    }

    public class LocationUploadItem
    {
        public string? Name { get; set; }
        public string? LocationType { get; set; }
        public string? Address { get; set; }
        public string? City { get; set; }
        public string? State { get; set; }
        public string? ZipCode { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public int Rating { get; set; }
        public string? Comments { get; set; }
        public List<string>? Tags { get; set; }
    }
}
