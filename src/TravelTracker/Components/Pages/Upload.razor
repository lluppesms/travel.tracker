@page "/upload"
@using TravelTracker.Data.Models
@using TravelTracker.Services.Interfaces
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@inject IDataImportService DataImportService
@inject IAuthenticationService AuthenticationService

<PageTitle>Upload Data - Travel Tracker</PageTitle>

<h1>Upload Travel Data</h1>

<div class="container mt-4">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(selectedFormat == "json" ? "active" : "")"
                                    type="button"
                                    @onclick="SelectJsonFormat"
                                    disabled="@isUploading">
                                JSON Upload
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(selectedFormat == "csv" ? "active" : "")"
                                    type="button"
                                    @onclick="SelectCsvFormat"
                                    disabled="@isUploading">
                                CSV Upload
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    @if (selectedFormat == "json")
                    {
                        <InputFile OnChange="HandleFileSelected" class="form-control mb-3" accept=".json" disabled="@isUploading" />
                    }
                    else
                    {
                        <InputFile OnChange="HandleFileSelected" class="form-control mb-3" accept=".csv" disabled="@isUploading" />
                    }

                    @if (selectedFileName != null)
                    {
                        <div class="alert alert-info">
                            <strong>Selected file:</strong> @selectedFileName
                            @if (validationResults.Any())
                            {
                                <div class="mt-2">
                                    <strong>Validation:</strong>
                                    <ul class="mb-0">
                                        @foreach (var result in validationResults)
                                        {
                                            <li class="@(result.IsSuccess ? "text-success" : "text-danger")">
                                                @result.Message
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }

                    @if (isUploading)
                    {
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: @uploadProgress%"
                                 aria-valuenow="@uploadProgress"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                @uploadProgress%
                            </div>
                        </div>
                    }

                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="ProcessUpload" disabled="@(!canUpload || isUploading)">
                            @if (isUploading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <span class="bi bi-upload"></span> Upload
                        </button>
                        <button class="btn btn-secondary ms-2" @onclick="ValidateFile" disabled="@(!canValidate || isUploading)">
                            Validate
                        </button>
                        <button class="btn btn-outline-secondary ms-2" @onclick="ClearSelection" disabled="@isUploading">
                            Clear
                        </button>
                    </div>

                    @if (uploadSummary != null)
                    {
                        <div class="alert alert-success mt-3">
                            <h6>Upload Summary:</h6>
                            <ul class="mb-0">
                                <li>Total locations processed: @uploadSummary.TotalProcessed</li>
                                <li>Successfully imported: @uploadSummary.SuccessCount</li>
                                <li>Failed: @uploadSummary.FailureCount</li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">@(selectedFormat == "json" ? "JSON" : "CSV") Format</h5>
                </div>
                <div class="card-body">
                    @if (selectedFormat == "json")
                    {
                        <p class="small">Your JSON file should follow this format:</p>
                        <pre class="small bg-light p-2"><code>{
  "locations": [
    {
      "name": "Yellowstone NP",
      "locationType": "National Park",
      "address": "WY 82190",
      "city": "Yellowstone",
      "state": "WY",
      "zipCode": "82190",
      "latitude": 44.427963,
      "longitude": -110.588455,
      "startDate": "2024-06-15",
      "endDate": "2024-06-18",
      "rating": 5,
      "comments": "Amazing!",
      "tags": ["national-park"]
    }
  ]
}</code></pre>
                    }
                    else
                    {
                        <p class="small">Your CSV file should have this header format:</p>
                        <pre class="small bg-light p-2"><code>Location,Arrival,Departure,Comments,Address,Latitude,Longitude,Type
    Yellowstone NP,2024-06-15,2024-06-18,Amazing geysers,"Yellowstone National Park, WY 82190",44.427963,-110.588455,"National Park"
Grand Canyon NP,2024-07-01,2024-07-03,Stunning views,"Grand Canyon, AZ 86023",36.1069,-112.1129,"National Park"</code></pre>
                        <p class="small mt-2 text-muted">
                            <strong>Note:</strong> State information will be extracted from the Address field.
                        </p>
                    }
                    <a href="@GetSampleFileUrl()"
                       download="@GetSampleFileName()"
                       class="btn btn-sm btn-outline-primary">
                        <span class="bi bi-download"></span> Download Sample
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isUploading = false;
    private bool canValidate = false;
    private bool canUpload = false;
    private int uploadProgress = 0;
    private List<DisplayValidationResult> validationResults = new();
    private UploadSummary? uploadSummary;
    private int currentUserId;
    private string selectedFormat = "csv";
    private const long MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    protected override void OnInitialized()
    {
        currentUserId = AuthenticationService.GetCurrentUserInternalId();
    }

    private void SelectJsonFormat()
    {
        if (isUploading) return;
        selectedFormat = "json";
        ClearSelection();
    }

    private void SelectCsvFormat()
    {
        if (isUploading) return;
        selectedFormat = "csv";
        ClearSelection();
    }

    private Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        validationResults.Clear();
        uploadSummary = null;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        canValidate = true;
        canUpload = false;
        return Task.CompletedTask;
    }

    private async Task ValidateFile()
    {
        if (selectedFile == null) return;

        try
        {
            validationResults.Clear();
            errorMessage = string.Empty;

            if (selectedFile.Size > MAX_FILE_SIZE)
            {
                validationResults.Add(new DisplayValidationResult
                {
                    IsSuccess = false,
                    Message = $"File size exceeds maximum allowed size of {MAX_FILE_SIZE / 1024 / 1024}MB"
                });
                canUpload = false;
                return;
            }

            validationResults.Add(new DisplayValidationResult { IsSuccess = true, Message = "File size is acceptable" });

            using var stream = selectedFile.OpenReadStream(MAX_FILE_SIZE);

            Services.Interfaces.ValidationResult validationResult;
            if (selectedFormat == "json")
            {
                validationResult = await DataImportService.ValidateJsonAsync(stream);
            }
            else
            {
                validationResult = await DataImportService.ValidateCsvAsync(stream);
            }

            foreach (var msg in validationResult.ValidationMessages)
            {
                validationResults.Add(new DisplayValidationResult { IsSuccess = true, Message = msg });
            }

            foreach (var error in validationResult.Errors)
            {
                validationResults.Add(new DisplayValidationResult { IsSuccess = false, Message = error });
            }

            canUpload = validationResult.IsValid;
        }
        catch (Exception ex)
        {
            errorMessage = $"Validation failed: {ex.Message}";
            canUpload = false;
        }
    }

    private async Task ProcessUpload()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file first.";
            return;
        }

        try
        {
            isUploading = true;
            errorMessage = string.Empty;
            uploadProgress = 0;

            using var stream = selectedFile.OpenReadStream(MAX_FILE_SIZE);

            ImportResult result;
            if (selectedFormat == "json")
            {
                result = await DataImportService.ImportFromJsonAsync(stream, currentUserId);
            }
            else
            {
                result = await DataImportService.ImportFromCsvAsync(stream, currentUserId);
            }

            uploadProgress = 100;
            StateHasChanged();

            uploadSummary = new UploadSummary
            {
                TotalProcessed = result.TotalRecords,
                SuccessCount = result.ImportedRecords,
                FailureCount = result.FailedRecords
            };

            if (result.Success)
            {
                successMessage = $"Upload complete! Imported {result.ImportedRecords} out of {result.TotalRecords} locations.";
            }
            else
            {
                errorMessage = "Upload failed. Please check validation errors.";
            }

            if (result.Errors.Any())
            {
                errorMessage += " Errors: " + string.Join("; ", result.Errors.Take(5));
                if (result.Errors.Count > 5)
                {
                    errorMessage += $" and {result.Errors.Count - 5} more...";
                }
            }

            ClearSelection();
        }
        catch (Exception ex)
        {
            errorMessage = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            uploadProgress = 0;
        }
    }

    private void ClearSelection()
    {
        selectedFile = null;
        selectedFileName = null;
        validationResults.Clear();
        canValidate = false;
        canUpload = false;
    }

    private string GetSampleFileUrl() => selectedFormat == "json" ? "/samples/sample-locations.json" : "/samples/sample-locations.csv";
    private string GetSampleFileName() => selectedFormat == "json" ? "sample-locations.json" : "sample-locations.csv";

    private class DisplayValidationResult
    {
        public bool IsSuccess { get; set; }
        public string Message { get; set; } = string.Empty;
    }

    private class UploadSummary
    {
        public int TotalProcessed { get; set; }
        public int SuccessCount { get; set; }
        public int FailureCount { get; set; }
    }
}
